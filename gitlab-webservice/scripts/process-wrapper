#!/bin/bash

set -e

# touch logs that would be generated by Rails
touch /var/log/gitlab/production.log

# pre-create known-good tmpdir
export TMPDIR=/tmp/gitlab
mkdir -p -m 3770 $TMPDIR

# switch to runtime directory
cd /srv/gitlab

if [ "${USE_GITLAB_LOGGER-1}" -eq 1 ]; then
  /usr/local/bin/gitlab-logger /var/log/gitlab &
else
  if command -v xtail >/dev/null; then
    xtail /var/log/gitlab &
  else
    tail -f /var/log/gitlab/* &
  fi
fi

if [ "${GITLAB_WEBSERVER^^}" = "PUMA" ]; then
  echo "Starting Puma"
  exec /srv/gitlab/bin/bundle exec puma --environment production \
    --config /srv/gitlab/config/puma.rb /srv/gitlab/config.ru
else
  echo "ERROR: Unknown Webserver requested '${GITLAB_WEBSERVER}'. Exiting"
  exit 1
fi
