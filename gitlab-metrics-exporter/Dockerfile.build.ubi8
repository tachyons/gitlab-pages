ARG BUILD_IMAGE=

FROM ${BUILD_IMAGE}

ARG NAMESPACE=gitlab-org
ARG PROJECT=gitlab-metrics-exporter
ARG VERSION=main
ARG API_URL=
ARG API_TOKEN=
ARG DNF_OPTS

ADD gitlab-go.tar.gz /

ENV PRIVATE_TOKEN=${API_TOKEN}

RUN dnf ${DNF_OPTS} install -by --nodocs git \
    && mkdir -p /assets \
    && ln -sf /usr/local/go/bin/* /usr/local/bin \
    && /gitlab-fetch \
        "${API_URL}" \
        "${NAMESPACE}" \
        "${PROJECT}" \
        "${VERSION}" \
    && cd ${PROJECT}-${VERSION} \
    && make \
    && make install \
    && cp --parents /usr/local/bin/gitlab-metrics-exporter /assets
